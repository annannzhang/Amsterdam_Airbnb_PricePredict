---
title: "MUSA 508 Final - Amsterdam"
author: 'Yuhao Sun'
date: "2022/12/06"
output: 
  html_document:
    theme: lumen
    toc: true
    toc_float: true
    toc_collapsed: true
    code_folding: hide
---

```{r setup, include=FALSE, message = FALSE,warning = FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE, quiet = TRUE, warning=FALSE)
```

# Setup

```{r Load R packages, include=TRUE, echo = TRUE, message = FALSE, warning = FALSE}
library(tidyverse)
library(sf)
library(RSocrata)
library(viridis)
library(spatstat)
library(ggplot2)
library(raster)
library(spdep)
library(FNN)
library(mapview)
library(grid)
library(gridExtra)
library(knitr)
library(stringr)
library(kableExtra)
library(tidycensus)
library(lubridate)
library(viridis)
library(stargazer)

install.packages("https://github.com/jrnold/ggthemes", repos = NULL, type = "source")
library(scales)
library(RColorBrewer)
library(gridExtra)
library(ggthemes)
library(readr)
library(ggcorrplot)
library(caret)

install.packages(ggthemes)
install.packages(sjmisc)
library(sjPlot)
library(sjmisc)
library(sjlabelled)
library(osmdata)

#text mining
library(tm)
library(wordcloud2)
library(SnowballC)
options(scipen=999)

source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")
```


## format

```{r formatting, include=FALSE, echo = TRUE, message = FALSE, warning = FALSE}
 
palette5 <- c("#FA8072","#9FE2BF","#FF006A","#FE4C35","#FE9900")
palette4 <- c("#FA8072","#9FE2BF","#FE4C35","#FE9900")
palette2 <- c("#D4ED91","#9CA998")
another.palette2 <- c("#D9D919","#E47833")

qBr <- function(df, variable, rnd) {
  if (missing(rnd)) {
    as.character(quantile(round(df[[variable]],0),
                          c(.01,.2,.4,.6,.8), na.rm=T))
  } else if (rnd == FALSE | rnd == F) {
    as.character(formatC(quantile(df[[variable]]), digits = 3),
                 c(.01,.2,.4,.6,.8), na.rm=T)
  }
}

qBr2 <- function(df, variable, rnd) {
  if (missing(rnd)) {
    as.character(round(quantile(round(df[[variable]],0),
                          c(.01,.2,.4,.6,.8), na.rm=T)))
  } else if (rnd == FALSE | rnd == F) {
    as.character(round(formatC(quantile(round(df[[variable]]), 0)),
                 c(.01,.2,.4,.6,.8), na.rm=T))
  }
}

q5 <- function(variable) {as.factor(ntile(variable, 5))}

plotTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle = element_text(face="italic"),
    plot.caption = element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.background = element_rect(fill = "grey80", color = "white"),
    strip.text = element_text(size=12),
    axis.title = element_text(size=12),
    axis.text = element_text(size=10),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"),
    strip.text.x = element_text(size = 14)
  )
}

mapTheme <- theme(plot.title =element_text(size=12),
                  plot.subtitle = element_text(size=8),
                  plot.caption = element_text(size = 8),
                  axis.line=element_blank(),
                  axis.text.x=element_blank(),
                  axis.text.y=element_blank(),
                  axis.ticks=element_blank(),
                  axis.title.x=element_blank(),
                  axis.title.y=element_blank(),
                  panel.background=element_blank(),
                  panel.border = element_rect(colour = "black", fill=NA, size=2),
                  panel.grid.major=element_line(colour = 'grey92'),
                  panel.grid.minor=element_blank(),
                  legend.direction = "vertical", 
                  legend.position = "right",
                  plot.margin = margin(1, 1, 1, 1, 'cm'),
                  legend.key.height = unit(1, "cm"), legend.key.width = unit(0.2, "cm"))

```

Function

```{r function, include=FALSE, echo = TRUE, message = FALSE, warning = FALSE}
nn_function <- function(measureFrom,measureTo,k) {
  measureFrom_Matrix <- as.matrix(measureFrom)
  measureTo_Matrix <- as.matrix(measureTo)
  nn <-   
    get.knnx(measureTo, measureFrom, k)$nn.dist
  output <-
    as.data.frame(nn) %>%
    rownames_to_column(var = "thisPoint") %>%
    gather(points, point_distance, V1:ncol(.)) %>%
    arrange(as.numeric(thisPoint)) %>%
    group_by(thisPoint) %>%
    summarize(pointDistance = mean(point_distance)) %>%
    arrange(as.numeric(thisPoint)) %>% 
    dplyr::select(-thisPoint) %>%
    pull()
  
  return(output)  
}


rquery.wordcloud <- function(x, type=c("text", "url", "file"), 
                          lang="english", excludeWords=NULL, 
                          textStemming=FALSE,  colorPalette="Dark2",
                          min.freq=3, max.words=200)
{ 
  library("tm")
  library("SnowballC")
  library("wordcloud")
  library("RColorBrewer") 
  
  if(type[1]=="file") text <- readLines(x)
  else if(type[1]=="url") text <- html_to_text(x)
  else if(type[1]=="text") text <- x
  
  # Load the text as a corpus
  docs <- Corpus(VectorSource(text))
  # Convert the text to lower case
  docs <- tm_map(docs, content_transformer(tolower))
  # Remove numbers
  docs <- tm_map(docs, removeNumbers)
  # Remove stopwords for the language 
  docs <- tm_map(docs, removeWords, stopwords(lang))
  # Remove punctuations
  docs <- tm_map(docs, removePunctuation)
  # Eliminate extra white spaces
  docs <- tm_map(docs, stripWhitespace)
  # Remove your own stopwords
  if(!is.null(excludeWords)) 
    docs <- tm_map(docs, removeWords, excludeWords) 
  # Text stemming
  if(textStemming) docs <- tm_map(docs, stemDocument)
  # Create term-document matrix
  tdm <- TermDocumentMatrix(docs)
  m <- as.matrix(tdm)
  v <- sort(rowSums(m),decreasing=TRUE)
  d <- data.frame(word = names(v),freq=v)
  # check the color palette name 
  if(!colorPalette %in% rownames(brewer.pal.info)) colors = colorPalette
  else colors = brewer.pal(8, colorPalette) 
  # Plot the word cloud
  set.seed(1234)
  wordcloud(d$word,d$freq, min.freq=min.freq, max.words=max.words,
            random.order=FALSE, rot.per=0.35, 
            use.r.layout=FALSE, colors=colors)
  
  invisible(list(tdm=tdm, freqTable = d))
}
#++++++++++++++++++++++
# Helper function
#++++++++++++++++++++++
# Download and parse webpage
html_to_text<-function(url){
  library(RCurl)
  library(XML)
  # download html
  html.doc <- getURL(url)  
  #convert to plain text
  doc = htmlParse(html.doc, asText=TRUE)
 # "//text()" returns all text outside of HTML tags.
 # We also donâ€™t want text such as style and script codes
  text <- xpathSApply(doc, "//text()[not(ancestor::script)][not(ancestor::style)][not(ancestor::noscript)][not(ancestor::form)]", xmlValue)
  # Format text vector into one character string
  return(paste(text, collapse = " "))
}
```

# Data Wrangling

## Load data

```{r load data, include=FALSE, echo = TRUE, message = FALSE, warning = FALSE, results='hide'}

listings <- st_read("listings.csv")

details <- st_read("listings_details.csv")

listings <- st_read("/Users/annzhang/Downloads/archive/listings.csv")
details <- read.csv("/Users/annzhang/Downloads/archive/listings_details.csv")
calendar <- read.csv("/Users/annzhang/Downloads/archive/calendar.csv")


calendar <- read.csv("calendar.csv")


#large neighborhood
neighborhood <- st_read('neighbourhoods.geojson')

#small neighborhood
neighbor2 <- st_read('neighbor2.json') %>% 
  st_transform(st_crs(neighborhood))

developing_area <- st_read('developing_area.json') %>% 
  st_transform(st_crs(neighborhood))

crowdsensor <- st_read('crowdsensor.json') %>% 
  st_transform(st_crs(neighborhood))

metro <- st_read('tram_metro_stops.json') %>% 
  st_transform(st_crs(neighborhood))

buildingyear <- st_read('buildingyearblock.json') %>% 
  st_transform(st_crs(neighborhood))

zipcode6 <- st_read('zipcode6.json') %>% 
  st_transform(st_crs(neighborhood))

zipcode4 <- st_read('zipcode4.json') %>% 
  st_transform(st_crs(neighborhood))
```

```{r  text, include=TRUE, echo = TRUE, message = FALSE, warning = FALSE}
details.sf <- st_as_sf(details,coords = c('longitude','latitude'),crs = 4326) %>% 
  st_transform(st_crs(neighborhood))

details.sf$price <- parse_number(details.sf$price)
details.sf$weekly_price <- parse_number(details.sf$weekly_price)
details.sf$monthly_price <- parse_number(details.sf$monthly_price)
details.sf$cleaning_fee <- parse_number(details.sf$cleaning_fee)
details.sf$extra_people <- parse_number(details.sf$extra_people)
details.sf$security_deposit <- parse_number(details.sf$security_deposit)
details.sf$beds <- as.numeric(details.sf$beds)
details.sf$minimum_nights <- as.numeric(details.sf$minimum_nights)
details.sf$maximum_nights <- as.numeric(details.sf$maximum_nights)
details.sf$number_of_reviews <- as.numeric(details.sf$number_of_reviews)
details.sf$review_scores_rating <- as.numeric(details.sf$review_scores_rating)
details.sf$review_scores_accuracy <- as.numeric(details.sf$review_scores_accuracy)
details.sf$review_scores_cleanliness<- as.numeric(details.sf$review_scores_cleanliness)
details.sf$review_scores_value <- as.numeric(details.sf$review_scores_value)
details.sf$reviews_per_month <- as.numeric(details.sf$reviews_per_month)

details.sf.raw <- details.sf
```



## Price 

```{r price panel, include=TRUE, echo = TRUE, message = FALSE, warning = FALSE}
# Available Calendar
available_calendar <- calendar %>%
  filter(available =="t")

available_calendar$listing_id <- as.character(available_calendar$listing_id)

# Price change
available_calendar <- available_calendar%>%
  mutate(price2 = gsub("^.","",price))%>%
  mutate(price2 = gsub(",","",price2))

available_calendar$price3 <- as.numeric(available_calendar$price2)

# Sum per month
available_calendar2 <- available_calendar%>%
  mutate(date2 = ymd(date))%>%
  mutate(month = month(date2))%>%
  group_by(listing_id, month) %>%
  summarize(month_price = mean(price3))
```

```{r panel length, include=TRUE, echo = TRUE, message = FALSE, warning = FALSE}
length(unique(calendar$listing_id))
length(unique(calendar$listing_id))*12
```


```{r deal with panel, include=TRUE, echo = TRUE, message = FALSE, warning = FALSE}
study.panel <- 
  expand.grid(listing_id = unique(calendar$listing_id),
              month=unique(available_calendar2$month))

study.panel$listing_id <- as.character(study.panel$listing_id)

listing_panel <- study.panel %>%
  left_join(available_calendar2) %>%
  mutate(each_month_price = 0)

o <- order(listing_panel[,"listing_id"],listing_panel[,"month"])
listing_panel <- listing_panel[o,]

xx <- 0

for(i in 2:nrow(listing_panel)){
  if(!is.na(listing_panel[i,3])){
    xx <- listing_panel[i,3]
    listing_panel[i,4]=listing_panel[i,3]
  }
  if(is.na(listing_panel[i,3])& listing_panel[i-1,1]==listing_panel[i,1]){
    listing_panel[i,4] <- xx
  }
  if(is.na(listing_panel[i,3])& listing_panel[i-1,1]!=listing_panel[i,1]){
    xx <- 0
    listing_panel[i,4] <- xx
  }
}

d <- order(listing_panel[,"listing_id"],-listing_panel[,"month"])
listing_panel <- listing_panel[d,]

for(i in 2:nrow(listing_panel)){
  if(listing_panel[i,4]==0){
    listing_panel[i,4]=listing_panel[i-1,4]
  }
}

o <- order(listing_panel[,"listing_id"],listing_panel[,"month"])
listing_panel <- listing_panel[o,]

listing_0price <- listing_panel %>%
  filter(each_month_price == 0)

no_price <- unique(listing_0price$listing_id)
no_price
```




```{r drop NA listings, include=FALSE, echo = TRUE, message = FALSE, warning = FALSE}
#Filter data with no price
listing_panel <- listing_panel %>%
  filter(!listing_id %in% no_price)
```


## Occupancy

```{r occupancy, fig.width=6.4, fig.height=3.8, include = TRUE, echo=TRUE, warning=FALSE, message=FALSE}
index <- function(x, flag = '0') {
  digit <- floor(log10(length(x))) + 1
  paste(flag, formatC(x, width = digit, flag = '0'), sep = '')
}

occupancy <- calendar%>%
  mutate(date2 = ymd(date))%>%
  mutate(month = month(date2),
         count = ifelse(available == "f", 1, 0),
         listing_id = as.character(listing_id))%>%
  filter(!listing_id %in% no_price) %>%
  group_by(listing_id, month) %>%
  summarize(monthly_occupancy = sum(count))

monthly_occupancy <- occupancy %>%
  mutate(month = as.character(month))%>%
  mutate(month = ifelse(month != 10 & month != 11 & month != 12, gsub("^","0",month), month)) %>%
  group_by(month) %>%
  summarise(mean_monthly_occupancy = mean(monthly_occupancy))

ggplot(monthly_occupancy, 
       aes(x=month, y=mean_monthly_occupancy, group =1)) +
  geom_line(size=1, color = "#FE9900") +
  labs(title = "Average Monthly Occupancy over 12 Months", subtitle = "Amsterdam, NL") +
  xlab("Month of the Year") +
  ylab("Average Occupancy") +
  plotTheme()
```



```{r price change, fig.width=8, fig.height=3.8, include = TRUE, echo=TRUE, warning= FALSE, message=FALSE}
Month_price <- calendar%>%
  mutate(date2 = ymd(date))%>%
  mutate(month = month(date2),
         listing_id = as.character(listing_id),
         price = parse_number(price))%>%
  mutate(month = as.character(month))%>%
  mutate(month = ifelse(month != 10 & month != 11 & month != 12, gsub("^","0",month), month)) %>%
  drop_na(price) %>%
  group_by(month) %>%
  summarize(mean_monthly_price = mean(price))


ggplot(Month_price, 
       aes(x=month, y=mean_monthly_price, group =1)) +
  geom_line(size=1, color = "#9FE2BF") +
  labs(title = "Average Price per Month per Airbnb", subtitle = "Amsterdam, NL") +
  xlab("Month of the Year") +
  ylab("Average Price") +
  plotTheme()
```




# Data Visualization


## Price per Bed

```{r plot listings, fig.width=6.4, fig.height=6.0, include=TRUE, echo = TRUE, message = FALSE, warning = FALSE}
details.sf <- 
  details.sf %>% 
  mutate(priceBed=price/beds) %>% 
  filter(priceBed <=1000)


ggplot()+
  geom_sf(data = neighborhood,fill='grey90',color = 'white')+
  geom_sf(data = details.sf, aes(colour=q5(priceBed)),size=.5)+
  scale_color_manual(values = palette5,
                     labels = qBr(details.sf,'priceBed'),
                     name = "Price per Bed (Quintile Breaks)")+
  labs(title = "Price per Bed, Airbnb Price on 2018-12-06",
       subtitle = 'Amsterdam, NL')+
  mapTheme()

```


## Airbnb Count Distribution (smaller Neighborhoods)

```{r include=TRUE, echo = TRUE, message = FALSE, warning = FALSE}
sf_use_s2(FALSE)
listings.sf<- listings %>% 
  st_as_sf(coords = c( "longitude","latitude"), crs = 4326, agr = "constant")

neighbor2 <- neighbor2 %>% 
  st_transform(st_crs(listings.sf))

listing.sf.neighbor2 <- st_intersection(listings.sf,neighbor2) %>% 
  dplyr::select(id, Buurt,Buurt_code) %>% 
  mutate(count=1) %>% 
  st_drop_geometry()

listings.sf <- left_join(listings.sf, listing.sf.neighbor2,by='id')

neighbo2.count <- listings.sf %>% 
  group_by(Buurt) %>% 
  summarise(airbnb.number = sum(count)) %>% 
  dplyr::select(Buurt, airbnb.number) %>% 
  st_drop_geometry()

```

```{r  plot the number of airbnb, fig.width=6.4, fig.height=6.0, include=TRUE, echo = TRUE, message = FALSE, warning = FALSE}
neighbor2 <- left_join(neighbor2,neighbo2.count,by="Buurt")

neighbor2 %>% ggplot() + 
      geom_sf(aes(fill = airbnb.number), color = 'white') +
      scale_fill_gradient(low = palette5[1], high = palette5[5],
                          name = "Count of Airbnb") +
      labs(title = "Count of Airbnb by ZIP Code", subtitle = "Amsterdam, NL; 2018") +
      mapTheme()
```

```{r fig.width=6.4, fig.height=6.0, include=TRUE, echo = TRUE, message = FALSE, warning = FALSE}
ggplot()+
  geom_sf(data = neighbor2, aes(fill=q5(airbnb.number)),color='transparent') +
  scale_fill_manual(values = palette5,
                    labels = qBr(neighbor2,'airbnb.number'), 
                    name = "Count of Airbnb") +
  labs(title = "Count of Airbnb by Neighborhood", subtitle = "Amsterdam, NL; 2018") +
  mapTheme()


```


# Exploration: Features & Amenities

## Feature summary
```{r basic features, include=TRUE, echo = TRUE, message = FALSE, warning = FALSE}

table.basic <- details.sf %>% 
  st_drop_geometry() %>% 
  dplyr::select(price, beds, bedrooms, bathrooms, accommodates, property_type) 

table.basic$property_type <- as.factor(table.basic$property_type)
unique(table.basic$property_type)

stargazer(as.data.frame(table.basic),
          type = "text",
          title ="Table 1. Basic Features Summary",
          single.row = TRUE,
          out.header = TRUE)

```


```{r}
table.basic %>%
  group_by(beds, bedrooms, bathrooms, property_type, accommodates) %>%
  summarize (Price = mean(price, na.rm = T)) %>% kable() %>%
  kable_styling() 
  
```

```{r plot basic.features 1,fig.width=10, fig.height=6.8, include=TRUE, echo = TRUE, message = FALSE, warning = FALSE}
amenitie_vars_pt <- c('property_type')
plotList.pt <- list()

for (i in amenitie_vars_pt){
plotList.pt[[i]] <- 
  details.sf %>%st_drop_geometry() %>% 
  dplyr::select(price,i) %>%
  filter(price<500) %>% 
  gather(Variable, value, -price) %>%
    ggplot(aes(value, price, fill=value)) + 
      #geom_bar(position = "dodge", stat = "summary", fun.y = "mean") + 
      geom_boxplot()+
      labs(x="value", y="price", 
           title = i) +
      theme(legend.position = "none")+
  plotTheme()
}

do.call(grid.arrange,c(plotList.pt, top = "Average Price with vs. without Amenities"))
```


```{r plot basic.features 2,fig.width=10, fig.height=6.8, include=TRUE, echo = TRUE, message = FALSE, warning = FALSE}
amenitie_vars_1 <- c('beds','bedrooms','bathrooms')
plotList.1 <- list()

for (i in amenitie_vars_1){
plotList.1[[i]] <- 
  details.sf %>%st_drop_geometry() %>% 
  dplyr::select(price,i) %>%
  filter(price<500) %>% 
  gather(Variable, value, -price) %>%
    ggplot(aes(value, price, fill=value)) + 
      #geom_bar(position = "dodge", stat = "summary", fun.y = "mean") + 
      geom_boxplot()+
      labs(x="value", y="price", 
           title = i) +
      theme(legend.position = "none")+
  plotTheme()
}

do.call(grid.arrange,c(plotList.1, ncol = 3, top = "Average Price with vs. without Amenities"))

bed <- details.sf %>%
  dplyr::select(beds, bedrooms, price, property_type) %>%
  st_drop_geometry() %>%
  na.omit() %>%
  group_by(property_type, bedrooms) %>%
  summarize(Price_Per_Bed = mean(price/beds, na.rm=T))

bed %>%
  ggplot() +
  geom_bar() + 
  facet_wrap(~)



#gather(Variable, bedrooms, property_type) %>%
  ggplot(aes(Variable, bedrooms, Value, fill = property_type)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~Variable, scales = "free", ncol=5) +
  theme(strip.text.x = element_text(size = 3)) +
  scale_fill_manual(values = c("#FFDD94", "#CCABDB")) +
  labs(title = "Indicator Differences Across Time and Space", subtitle = "San Diego, CA; 2009 vs. 2019", caption = "Figure 3") +
  plotTheme() + theme(legend.position="bottom")


```

## Amenities

```{r amenities, include=TRUE, echo = TRUE, message = FALSE, warning = FALSE}
#pool
details.sf <- details.sf %>%
  mutate(pool = ifelse(str_detect(amenities, "Pool"), "1 Pool", "0 No Pool"))

#Paid parking off premises
details.sf <- details.sf %>%
  mutate(parking = ifelse(str_detect(amenities, "Paid parking off premises"), 
                          "1 Parking", "0 No Parking"))

#Indoor fireplace
details.sf <- details.sf %>%
  mutate(fireplace = ifelse(str_detect(amenities, "Indoor fireplace"), 
                          "1 Fireplace", "0 No Fireplace"))

#Waterfront
details.sf <- details.sf %>%
  mutate(waterfront = ifelse(str_detect(amenities, "Waterfront"), 
                          "1 Waterfront", "0 No waterfront"))

#Kitchen
details.sf <- details.sf %>%
  mutate(kitchen = ifelse(str_detect(amenities, "Kitchen"), 
                          "1 Kitchen", "0 No kitchen"))

#Air conditioning
details.sf <- details.sf %>%
  mutate(AC = ifelse(str_detect(amenities, "Air conditioning"), 
                          "1 AC", "0 No AC"))
```

## Amenities x Price

```{r plot amenities,fig.width=10, fig.height=6.8, include=TRUE, echo = TRUE, message = FALSE, warning = FALSE}
amenitie_vars <- c('fireplace','waterfront','pool','parking','kitchen','AC')
plotList <- list()

for (i in amenitie_vars){
plotList[[i]] <- 
  details.sf %>%st_drop_geometry() %>% 
  dplyr::select(price,i) %>%
  filter(price<500) %>% 
  gather(Variable, value, -price) %>%
    ggplot(aes(value, price, fill=value)) + 
      #geom_bar(position = "dodge", stat = "summary", fun.y = "mean") + 
      geom_boxplot()+
      scale_fill_manual(values = palette2) +
      labs(x="value", y="price", 
           title = i) +
      theme(legend.position = "none")+
  plotTheme()
}

do.call(grid.arrange,c(plotList, ncol = 3, top = "Average Price with vs. without Amenities"))
```


```{r number of amenties listed, include=FALSE, echo = TRUE, message = FALSE, warning = FALSE}
library(stringr)

details.sf <- details.sf %>% 
  mutate(amenities.number = str_count(amenities,",")+1)

```


# Neighborhood Effect

```{r Neighborhood Effect, include=TRUE, echo = TRUE, message = FALSE, warning = FALSE }
details.sf.neighbor <- st_intersection(details.sf,zipcode4) %>% 
  dplyr::select(id, Postcode4) %>% 
  st_drop_geometry()

details.sf <- left_join(details.sf,details.sf.neighbor,by='id')

```


```{r neighbor effect2 , include=TRUE, echo = TRUE, message = FALSE, warning = FALSE}
neighbor2 <- neighbor2 %>% 
  st_transform(st_crs(listings.sf))

listing.sf.neighbor2 <- st_intersection(listings.sf,neighbor2) %>% 
  dplyr::select(id, Buurt,Buurt_code) %>% 
  mutate(count=1) %>% st_drop_geometry()

details.sf$id <- as.character(details.sf$id)

detail.sf <- left_join(details.sf,listing.sf.neighbor2, by = "id")
```


# External Features

## Access to Metro 


```{r Distance to metro, fig.width=6.4, fig.height=6.0, include=TRUE, echo = TRUE, message = FALSE, warning = FALSE}
listings$longitude = as.numeric(listings$longitude)
listings$latitude = as.numeric(listings$latitude)
listings.sf<- listings %>% 
  st_as_sf(coords = c( "longitude","latitude"), crs = 4326, agr = "constant")

st_crs(metro) <- st_crs(listings.sf)

st_c <- st_coordinates

details.sf.c <- st_centroid(details.sf)%>%
  st_transform('ESRI:102013')
metro.c <- st_centroid(metro)%>%
  st_transform('ESRI:102013')

details.sf <- details.sf%>%
  mutate(dist.metro =nn_function(st_coordinates(details.sf.c),st_coordinates(metro.c),1))

metro <- metro%>%
  st_transform('ESRI:102013')
listings.sf <- listings.sf%>%
  st_transform('ESRI:102013')

listings <- listings%>%
  mutate(distance_to_metro =nn_function(st_c(listings.sf), st_c(metro),1))

ggplot()+
  geom_sf(data = neighbor2, fill = "light grey", color= "grey")+
  geom_point(data = listings,
             aes(x= longitude, y = latitude, color = distance_to_metro), 
             fill = "transparent", size = 0.86, alpha = 0.6) +
  scale_colour_viridis(direction = -1,
                       discrete = FALSE, 
                       option = "plasma", name = "Distance to Metro Stations")+
  geom_sf(data = metro, fill="red")+
  ylim(min(listings$latitude), max(listings$latitude))+
  xlim(min(listings$longitude), max(listings$longitude))+
  labs(title="Choropleth Map for Distance to Metro Stations",
       caption = "Figure")+
  mapTheme()
```


## Cultural Historic Exploration Areas


```{r}

CHE <- st_read('Cultural Historic Exploration.csv') %>% 
  dplyr::select(OBJECTNUMMER, LAT, LNG) %>%
  st_as_sf(coords = c("LNG", "LAT"), crs = 	st_crs(neighborhood), agr = "constant") %>%
  st_transform(st_crs(neighborhood)) %>%
  filter(!st_is_empty(.))

plot(CHE)
ggplot()+
  geom_sf(data = neighborhood, fill='grey90', color = 'white')+
  geom_sf(data = CHE, color='Purple') +
  labs(title = "Cultural Historic Exploration Areas",
       subtitle = 'Amsterdam, NL')+
  mapTheme()

```






# Correlation Matrix


```{r Clean Data}

details.clean <-
  details.sf %>%
  dplyr::select(id, property_type, room_type, accommodates, bathrooms, bedrooms, beds, bed_type, minimum_nights, number_of_reviews, review_scores_rating, instant_bookable, availability_30, amenities.number, dist.metro, price, Postcode4, parking, fireplace, waterfront, kitchen, pool, AC) %>%
  na.omit %>%
  st_drop_geometry()


```


```{r Correlation Matrix, warning = FALSE, message = FALSE, fig.width=10}
numericVars <- 
  select_if(st_drop_geometry(details.clean), is.numeric) %>% na.omit()
ggcorrplot(
  round(cor(numericVars), 1), 
  p.mat = cor_pmat(numericVars),
  colors = c("#B0E0E6", "white", "#B272A6"),
  type="lower",
  insig = "blank") +  
    labs(title = "Correlation Across Numeric Variables") 
```



# Primary Model

Factors: 

```{r}

reg.1 <- 
  lm(price ~ ., data = details.clean %>% dplyr::select(price, bedrooms, bathrooms,  amenities.number, Postcode4, room_type, accommodates, minimum_nights, pool, waterfront, parking, fireplace, pool, availability_30, AC, bed_type, property_type, instant_bookable, number_of_reviews, review_scores_rating, dist.metro))
  
summary(reg.1)

```









